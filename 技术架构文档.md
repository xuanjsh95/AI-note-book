# AI记事本技术架构文档

## 1. 系统架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├─────────────────────────────────────────────────────────────┤
│  Web前端 (React)  │  移动端 (React Native)  │  桌面端 (Electron) │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        网关层                                │
├─────────────────────────────────────────────────────────────┤
│           Nginx 反向代理 + SSL终止 + 负载均衡                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                              │
├─────────────────────────────────────────────────────────────┤
│  API网关    │  用户服务    │  笔记服务    │  AI服务    │  文件服务  │
│ (Express)   │ (Express)   │ (Express)   │ (FastAPI)  │ (Express) │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据访问层                              │
├─────────────────────────────────────────────────────────────┤
│           Prisma ORM + 连接池管理 + 查询优化                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────┤
│ PostgreSQL │  Redis缓存  │  文件存储   │  搜索引擎  │  消息队列  │
│  (主数据库) │  (会话/缓存) │ (AWS S3)   │(Elasticsearch)│ (Redis)  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                              │
├─────────────────────────────────────────────────────────────┤
│  OpenAI API │  邮件服务   │  短信服务   │  支付服务  │  监控服务  │
│   (AI功能)  │ (SendGrid) │ (Twilio)   │ (Stripe)  │(DataDog)  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈选择理由

#### 前端技术栈
- **React 18**: 成熟的前端框架，生态丰富，支持并发特性
- **TypeScript**: 类型安全，提高代码质量和开发效率
- **Vite**: 快速的构建工具，支持热更新和模块联邦
- **Redux Toolkit**: 简化状态管理，内置最佳实践
- **Ant Design**: 企业级UI组件库，设计规范统一
- **Slate.js**: 可定制的富文本编辑器框架

#### 后端技术栈
- **Node.js**: JavaScript全栈开发，团队技能统一
- **Express.js**: 轻量级Web框架，中间件生态丰富
- **Prisma**: 现代化ORM，类型安全的数据库访问
- **PostgreSQL**: 功能强大的关系型数据库，支持JSON和全文搜索
- **Redis**: 高性能缓存和会话存储

## 2. 核心模块设计

### 2.1 用户认证模块

```typescript
// 用户认证架构
interface AuthModule {
  // JWT Token管理
  tokenService: {
    generateAccessToken(userId: string): string;
    generateRefreshToken(userId: string): string;
    verifyToken(token: string): TokenPayload;
    refreshAccessToken(refreshToken: string): string;
  };
  
  // 密码管理
  passwordService: {
    hashPassword(password: string): Promise<string>;
    verifyPassword(password: string, hash: string): Promise<boolean>;
    generateResetToken(): string;
  };
  
  // 会话管理
  sessionService: {
    createSession(userId: string): Promise<Session>;
    getSession(sessionId: string): Promise<Session | null>;
    destroySession(sessionId: string): Promise<void>;
  };
}
```

#### 认证流程
1. **用户注册**
   - 邮箱验证 → 密码加密 → 用户创建 → 发送欢迎邮件

2. **用户登录**
   - 凭据验证 → 生成JWT → 创建会话 → 返回Token

3. **Token刷新**
   - 验证RefreshToken → 生成新AccessToken → 更新会话

### 2.2 笔记管理模块

```typescript
// 笔记管理架构
interface NoteModule {
  // 笔记CRUD
  noteService: {
    createNote(data: CreateNoteDto): Promise<Note>;
    updateNote(id: string, data: UpdateNoteDto): Promise<Note>;
    deleteNote(id: string): Promise<void>;
    getNoteById(id: string): Promise<Note | null>;
    getUserNotes(userId: string, filters: NoteFilters): Promise<Note[]>;
  };
  
  // 版本控制
  versionService: {
    createVersion(noteId: string, content: any): Promise<NoteVersion>;
    getVersionHistory(noteId: string): Promise<NoteVersion[]>;
    restoreVersion(noteId: string, versionId: string): Promise<Note>;
  };
  
  // 搜索服务
  searchService: {
    indexNote(note: Note): Promise<void>;
    searchNotes(query: string, userId: string): Promise<SearchResult[]>;
    updateIndex(noteId: string, content: any): Promise<void>;
  };
}
```

#### 笔记数据结构
```typescript
interface Note {
  id: string;
  title: string;
  content: SlateNode[]; // Slate.js文档结构
  contentText: string;  // 纯文本用于搜索
  tags: string[];
  notebookId: string;
  userId: string;
  metadata: {
    wordCount: number;
    readingTime: number;
    lastEditedAt: Date;
    version: number;
  };
  settings: {
    isPublic: boolean;
    allowComments: boolean;
    password?: string;
  };
  createdAt: Date;
  updatedAt: Date;
}
```

### 2.3 AI服务模块

```typescript
// AI服务架构
interface AIModule {
  // 文本处理
  textService: {
    completeText(prompt: string, context: string): Promise<string>;
    improveWriting(text: string): Promise<string>;
    summarizeContent(text: string): Promise<string>;
    translateText(text: string, targetLang: string): Promise<string>;
  };
  
  // 内容分析
  analysisService: {
    extractKeywords(text: string): Promise<string[]>;
    generateTags(content: string): Promise<string[]>;
    analyzeEmotion(text: string): Promise<EmotionAnalysis>;
    detectLanguage(text: string): Promise<string>;
  };
  
  // 多媒体处理
  mediaService: {
    extractTextFromImage(imageUrl: string): Promise<string>;
    transcribeAudio(audioUrl: string): Promise<string>;
    generateImageCaption(imageUrl: string): Promise<string>;
  };
}
```

#### AI服务集成策略
```typescript
// AI服务配置
const aiConfig = {
  providers: {
    openai: {
      apiKey: process.env.OPENAI_API_KEY,
      models: {
        text: 'gpt-4-turbo-preview',
        vision: 'gpt-4-vision-preview',
        whisper: 'whisper-1'
      },
      rateLimits: {
        requestsPerMinute: 60,
        tokensPerMinute: 150000
      }
    },
    fallback: {
      // 本地模型或其他服务商
      enabled: true,
      provider: 'huggingface'
    }
  },
  caching: {
    enabled: true,
    ttl: 3600, // 1小时
    maxSize: '100MB'
  }
};
```

## 3. 数据库设计详解

### 3.1 数据库架构

```sql
-- 数据库配置
CREATE DATABASE ai_notebook 
  WITH ENCODING 'UTF8' 
  LC_COLLATE='en_US.UTF-8' 
  LC_CTYPE='en_US.UTF-8';

-- 启用扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- 用于模糊搜索
CREATE EXTENSION IF NOT EXISTS "btree_gin"; -- 用于复合索引
```

### 3.2 核心表设计

#### 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url TEXT,
    profile JSONB DEFAULT '{}',
    settings JSONB DEFAULT '{}',
    subscription_plan VARCHAR(50) DEFAULT 'free',
    email_verified BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### 笔记本表 (notebooks)
```sql
CREATE TABLE notebooks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    color VARCHAR(7) DEFAULT '#1890ff',
    icon VARCHAR(50) DEFAULT 'book',
    settings JSONB DEFAULT '{}',
    sort_order INTEGER DEFAULT 0,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_notebooks_user_id ON notebooks(user_id);
CREATE INDEX idx_notebooks_sort_order ON notebooks(user_id, sort_order);
```

#### 笔记表 (notes)
```sql
CREATE TABLE notes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    notebook_id UUID REFERENCES notebooks(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    content JSONB NOT NULL, -- Slate.js文档结构
    content_text TEXT, -- 纯文本用于搜索
    excerpt TEXT, -- 摘要
    tags TEXT[] DEFAULT '{}',
    metadata JSONB DEFAULT '{}',
    settings JSONB DEFAULT '{}',
    is_favorite BOOLEAN DEFAULT FALSE,
    is_archived BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    deleted_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_notes_user_id ON notes(user_id) WHERE is_deleted = FALSE;
CREATE INDEX idx_notes_notebook_id ON notes(notebook_id) WHERE is_deleted = FALSE;
CREATE INDEX idx_notes_tags ON notes USING GIN(tags);
CREATE INDEX idx_notes_content_text ON notes USING GIN(to_tsvector('english', content_text));
CREATE INDEX idx_notes_updated_at ON notes(updated_at DESC);
```

### 3.3 性能优化策略

#### 分区策略
```sql
-- 按时间分区笔记表（适用于大量数据）
CREATE TABLE notes_y2024m01 PARTITION OF notes
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE notes_y2024m02 PARTITION OF notes
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

#### 缓存策略
```typescript
// Redis缓存配置
const cacheConfig = {
  // 用户会话缓存
  session: {
    prefix: 'session:',
    ttl: 86400 * 7 // 7天
  },
  
  // 笔记内容缓存
  note: {
    prefix: 'note:',
    ttl: 3600 // 1小时
  },
  
  // 搜索结果缓存
  search: {
    prefix: 'search:',
    ttl: 1800 // 30分钟
  },
  
  // AI结果缓存
  ai: {
    prefix: 'ai:',
    ttl: 86400 // 24小时
  }
};
```

## 4. API设计规范

### 4.1 RESTful API设计

#### 统一响应格式
```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  meta?: {
    pagination?: {
      page: number;
      limit: number;
      total: number;
      totalPages: number;
    };
    timestamp: string;
    requestId: string;
  };
}
```

#### 错误处理
```typescript
// 错误代码定义
enum ErrorCode {
  // 认证错误
  UNAUTHORIZED = 'AUTH_001',
  TOKEN_EXPIRED = 'AUTH_002',
  INVALID_CREDENTIALS = 'AUTH_003',
  
  // 业务错误
  NOTE_NOT_FOUND = 'NOTE_001',
  NOTEBOOK_NOT_FOUND = 'NOTEBOOK_001',
  PERMISSION_DENIED = 'PERM_001',
  
  // 系统错误
  INTERNAL_ERROR = 'SYS_001',
  DATABASE_ERROR = 'SYS_002',
  EXTERNAL_SERVICE_ERROR = 'SYS_003'
}
```

### 4.2 API版本控制

```typescript
// 版本控制策略
const apiVersioning = {
  strategy: 'url', // /api/v1/notes
  currentVersion: 'v1',
  supportedVersions: ['v1'],
  deprecationPolicy: {
    warningPeriod: '6 months',
    supportPeriod: '12 months'
  }
};
```

### 4.3 接口文档

#### 笔记相关接口
```yaml
# OpenAPI 3.0 规范
paths:
  /api/v1/notes:
    get:
      summary: 获取笔记列表
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: search
          in: query
          schema:
            type: string
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
      responses:
        '200':
          description: 成功返回笔记列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotesResponse'
    
    post:
      summary: 创建新笔记
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNoteRequest'
      responses:
        '201':
          description: 笔记创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'
```

## 5. 安全架构

### 5.1 认证与授权

```typescript
// JWT配置
const jwtConfig = {
  accessToken: {
    secret: process.env.JWT_ACCESS_SECRET,
    expiresIn: '15m',
    algorithm: 'HS256'
  },
  refreshToken: {
    secret: process.env.JWT_REFRESH_SECRET,
    expiresIn: '7d',
    algorithm: 'HS256'
  }
};

// 权限控制
interface Permission {
  resource: string; // 'note', 'notebook', 'user'
  action: string;   // 'create', 'read', 'update', 'delete'
  condition?: any;  // 额外条件
}

class AuthorizationService {
  async checkPermission(
    userId: string, 
    permission: Permission
  ): Promise<boolean> {
    // 实现权限检查逻辑
  }
}
```

### 5.2 数据安全

```typescript
// 数据加密配置
const encryptionConfig = {
  // 敏感数据加密
  algorithm: 'aes-256-gcm',
  keyDerivation: 'pbkdf2',
  iterations: 100000,
  
  // 传输加密
  tls: {
    minVersion: 'TLSv1.2',
    ciphers: [
      'ECDHE-RSA-AES128-GCM-SHA256',
      'ECDHE-RSA-AES256-GCM-SHA384'
    ]
  }
};

// 输入验证
const validationRules = {
  note: {
    title: {
      required: true,
      maxLength: 255,
      sanitize: true
    },
    content: {
      required: true,
      maxSize: '10MB',
      allowedTags: ['p', 'h1', 'h2', 'h3', 'strong', 'em']
    }
  }
};
```

### 5.3 安全中间件

```typescript
// 安全中间件配置
const securityMiddleware = {
  helmet: {
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        scriptSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "https:"],
        connectSrc: ["'self'", "https://api.openai.com"]
      }
    },
    hsts: {
      maxAge: 31536000,
      includeSubDomains: true,
      preload: true
    }
  },
  
  rateLimit: {
    windowMs: 15 * 60 * 1000, // 15分钟
    max: 100, // 限制每个IP 100个请求
    message: '请求过于频繁，请稍后再试'
  },
  
  cors: {
    origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
    credentials: true,
    optionsSuccessStatus: 200
  }
};
```

## 6. 监控与日志

### 6.1 应用监控

```typescript
// 监控配置
const monitoringConfig = {
  metrics: {
    // 应用指标
    application: {
      requestDuration: true,
      requestCount: true,
      errorRate: true,
      activeUsers: true
    },
    
    // 业务指标
    business: {
      notesCreated: true,
      aiRequestsCount: true,
      userEngagement: true
    }
  },
  
  alerts: {
    errorRate: {
      threshold: 0.05, // 5%
      window: '5m'
    },
    responseTime: {
      threshold: 2000, // 2秒
      window: '5m'
    },
    diskSpace: {
      threshold: 0.8, // 80%
      window: '1m'
    }
  }
};
```

### 6.2 日志系统

```typescript
// 日志配置
const loggingConfig = {
  level: process.env.LOG_LEVEL || 'info',
  format: 'json',
  
  transports: {
    console: {
      enabled: process.env.NODE_ENV === 'development',
      colorize: true
    },
    file: {
      enabled: true,
      filename: 'logs/app.log',
      maxSize: '10MB',
      maxFiles: 5
    },
    elasticsearch: {
      enabled: process.env.NODE_ENV === 'production',
      host: process.env.ELASTICSEARCH_HOST,
      index: 'ai-notebook-logs'
    }
  },
  
  // 敏感信息过滤
  sanitize: {
    fields: ['password', 'token', 'apiKey'],
    replacement: '[REDACTED]'
  }
};
```

## 7. 部署架构

### 7.1 容器化部署

```dockerfile
# Dockerfile for Node.js backend
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine AS runtime
WORKDIR /app

# 安全配置
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

COPY --from=builder /app/node_modules ./node_modules
COPY . .

USER nextjs
EXPOSE 3000

CMD ["npm", "start"]
```

### 7.2 Kubernetes配置

```yaml
# k8s deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-notebook-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ai-notebook-api
  template:
    metadata:
      labels:
        app: ai-notebook-api
    spec:
      containers:
      - name: api
        image: ai-notebook/api:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
```

### 7.3 CI/CD流水线

```yaml
# GitHub Actions workflow
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test
      - run: npm run lint
      - run: npm run type-check

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker image
        run: |
          docker build -t ai-notebook/api:${{ github.sha }} .
          docker tag ai-notebook/api:${{ github.sha }} ai-notebook/api:latest
      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push ai-notebook/api:${{ github.sha }}
          docker push ai-notebook/api:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/ai-notebook-api api=ai-notebook/api:${{ github.sha }}
          kubectl rollout status deployment/ai-notebook-api
```

## 8. 性能优化策略

### 8.1 前端性能优化

```typescript
// 代码分割配置
const codeSpittingConfig = {
  // 路由级别分割
  routes: {
    lazy: true,
    preload: 'hover' // 鼠标悬停时预加载
  },
  
  // 组件级别分割
  components: {
    editor: 'dynamic', // 富文本编辑器动态加载
    charts: 'dynamic'  // 图表组件动态加载
  },
  
  // 第三方库分割
  vendors: {
    react: 'separate',
    antd: 'separate',
    lodash: 'tree-shaking'
  }
};

// 缓存策略
const cacheStrategy = {
  // Service Worker缓存
  serviceWorker: {
    enabled: true,
    strategy: 'stale-while-revalidate',
    cacheName: 'ai-notebook-v1'
  },
  
  // 浏览器缓存
  browserCache: {
    static: '1y',    // 静态资源
    api: '5m',       // API响应
    images: '30d'    // 图片资源
  }
};
```

### 8.2 后端性能优化

```typescript
// 数据库连接池配置
const dbPoolConfig = {
  min: 2,
  max: 10,
  acquireTimeoutMillis: 30000,
  createTimeoutMillis: 30000,
  destroyTimeoutMillis: 5000,
  idleTimeoutMillis: 30000,
  reapIntervalMillis: 1000,
  createRetryIntervalMillis: 100
};

// 查询优化
const queryOptimization = {
  // 预加载关联数据
  include: {
    notes: {
      include: {
        notebook: true,
        tags: true,
        attachments: true
      }
    }
  },
  
  // 分页查询
  pagination: {
    defaultLimit: 20,
    maxLimit: 100,
    cursor: true // 使用游标分页
  },
  
  // 查询缓存
  cache: {
    enabled: true,
    ttl: 300, // 5分钟
    invalidateOn: ['create', 'update', 'delete']
  }
};
```

---

本技术架构文档将随着项目发展持续更新，确保架构设计能够支撑产品的长期发展需求。